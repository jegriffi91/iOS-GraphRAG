# Setup Guide: The "Last Mile" Connection

The SQLite database is inert on its own. The MCP Server (your Python script) is the bridge. You must "register" this script in your AI client's configuration file.

## Step 0: Install uv (If needed)

We use `uv` for high-performance Python package management.

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

## Step 1: The Environment Setup

1. **Create a tools directory:**
   ```bash
   mkdir -p ~/tools/ios-architect
   cd ~/tools/ios-architect
   ```

2. **Initialize Environment:**
   ```bash
   uv init
   uv venv --python 3.11
   source .venv/bin/activate
   ```

3. **Install Dependencies:**
   > [!IMPORTANT]
   > For M3 Max/Apple Silicon, we install a specific PyTorch build first to ensure clean MPS (Metal Performance Shaders) support.

   ```bash
   # Install PyTorch (Standard PyPI wheels include MPS support for Mac)
   uv pip install torch torchvision

   # Install MCP and Tooling
   uv pip install "mcp[cli]" tree-sitter tree-sitter-swift tree-sitter-objc networkx numpy sentence-transformers tqdm
   ```

## Step 2: Build the Graph

1. Drop the code generated by the `PRODUCTION_HARDENING_PROMPT.md` into `indexer_prod.py`.
2. Run the indexer pointing to your 1M+ line repository:

```bash
uv run indexer_prod.py --repo /path/to/your/ios-project
```

**Result:** A `knowledge-graph.sqlite` file will be created.

## Step 3: Register the Server

### Option A: Claude Desktop
Add this to `~/Library/Application Support/Claude/claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "ios-architect": {
      "command": "/Users/YOUR_USER/tools/ios-architect/.venv/bin/python",
      "args": [
        "/Users/YOUR_USER/tools/ios-architect/server_prod.py"
      ],
      "env": {
        "GRAPH_DB_PATH": "/Users/YOUR_USER/tools/ios-architect/knowledge-graph.sqlite"
      }
    }
  }
}
```

### Option B: GitHub Copilot (VS Code)
Add this to your VS Code `settings.json`:

```json
"github.copilot.chat.mcp.servers": {
    "ios-architect": {
        "command": "/Users/YOUR_USER/tools/ios-architect/.venv/bin/python",
        "args": ["/Users/YOUR_USER/tools/ios-architect/server_prod.py"],
        "env": {
            "GRAPH_DB_PATH": "/Users/YOUR_USER/tools/ios-architect/knowledge-graph.sqlite"
        }
    }
}
```

## Step 4: Verification

Before using it in chat, verify the toolchain with the MCP Inspector:

```bash
npx @modelcontextprotocol/inspector \
  /Users/YOUR_USER/tools/ios-architect/.venv/bin/python \
  /Users/YOUR_USER/tools/ios-architect/server_prod.py
```

1. Select the `trace_dependencies` tool.
2. Enter a known file path.
3. If you see valid JSON architecture data, you're ready.

## Troubleshooting

- **ModuleNotFoundError:** Ensure your config points to the absolute path of the `.venv/bin/python` interpreter.
- **Stale Data:** If you do a massive refactor, re-run `indexer_prod.py` to refresh the "Map".
- **MPS Not Detected:** Ensure you followed the specific PyTorch install step in Step 1.
